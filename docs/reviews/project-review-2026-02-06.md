# Project Review: footprint-core

**Date**: 2026-02-06
**Scope**: L0 Core implementation, CI infrastructure, specification documents, project architecture

---

## 1. 総合評価

CI グリーン（ユニットテスト 5 件 + 統合テスト 2 件 合格）。L0 Core は仕様に沿った堅実な実装であり、ゼロ外部依存という設計判断は災害用途の堅牢性要件に適合している。仕様ドキュメント群（constitution/）は充実しており、SSOT として一貫性がある。以下、領域ごとに詳細を述べる。

---

## 2. アーキテクチャ

### 良い点

- **4 層分離（L0–L3）** が明確で、各層の責務境界が仕様レベルで定義されている
- **L0 は暗号学的 integrity を持たない** という割り切りが正しく、正規化の定義までを責務としている（IF-INTEG-001）
- **append-only** セマンティクスが一貫しており、update/delete パスが存在しない
- **CLI（stdin/stdout JSON）** をインターフェースとしたことで、テスト容易性と他システムとの統合性が確保されている

### 懸念点

- `committed_at` フィールドが入力の `capturedAt` をそのまま正規化したものになっている（`lib.rs:337-339`）。仕様では `committed_at` は「記録時刻」だが、実際には「イベントが永続化された時刻（サーバー/デバイスの現在時刻）」を意図している可能性がある。入力のキャプチャ時刻と永続化時刻が同一フィールドに入ると、後段で区別できなくなる。仕様の意図を再確認すべき
- L1 以降がスケルトンのため、L0 → L1 のインターフェース契約（canonical event の受け渡し方法）がまだ定義されていない

---

## 3. コード品質（`core/src/lib.rs`）

### 良い点

- **ゼロ外部依存**: JSON パーサー、RFC 3339 パーサー、UTC 変換、civil date 計算をすべて自前実装。災害用途で依存の脆弱性やビルド不安定を排除する判断として合理的
- **BTreeMap** による自動アルファベット順保証で、正規化仕様（IF-CANON-001）を構造的に満たしている
- **flush + sync_data** による耐久性保証（`lib.rs:376-379`）が仕様の crash durability 要件に合致
- エラー型 `CoreError` がコード＋メッセージの構造化 JSON を返す設計で、呼び出し側のハンドリングが容易
- Unicode サロゲートペアの正しいハンドリング（`lib.rs:839-868`）
- 数値正規化（trailing zero 削除、指数表記の正規化）が丁寧

### 改善提案

| 箇所 | 内容 | 優先度 |
|------|------|--------|
| `lib.rs:328` `append_trace` | `committed_at` を入力の `capturedAt` から取っているが、「実際のコミット時刻」を別途記録する設計が将来必要になる可能性がある。フィールド名の意味論を仕様側で明確化すべき | 中 |
| `lib.rs:345-347` | `event_id` に `trace_id` をそのまま使用している。一意性の保証が呼び出し側に委ねられており、重複 trace_id が来た場合に append-only の意味論は壊れないが、検索時に混乱する可能性がある | 低 |
| `lib.rs:289` | `payload` が `null` の場合 `JsonValue::Null` がイベントに含まれる。仕様では「null は省略ではなく明示的に null として出力」なのでこれは正しいが、payload が省略された場合も null として出力されるため、「送信者が payload を含めなかった」と「送信者が明示的に null を送った」の区別がつかない | 低 |
| `lib.rs:921` `parse_number` | JSON 数値を文字列として保持しているが、正規化後も `1.0` → `1`、`-0.0` → `0` のような変換が行われる。これは正規化ルール通りだが、`1e999` のような極端な値が来た場合の挙動が未定義。拒否するかそのまま保持するか方針を決めておくとよい | 低 |

### セキュリティ

- **パストラバーサル**: `--store` 引数と `FOOTPRINT_CORE_STORE_PATH` 環境変数で任意パスへの書き込みが可能。CLI ツールとしては標準的だが、将来 API 経由で呼ぶ場合はパスのバリデーションが必要
- **入力サイズ制限なし**: stdin から読む JSON のサイズに上限がない（`main.rs:7` `read_to_string`）。巨大入力による OOM の可能性がある。CLI 用途では許容範囲だが、API 化時に制限が必要
- **JSON パーサーのロバスト性**: 手書き JSON パーサーは十分にテストされているが、ファジングテストがあるとさらに信頼性が上がる
- **unknown field の拒否**（`lib.rs:296-301`）がスキーマ準拠で正しく実装されている

---

## 4. テスト

### 現状

| 種別 | 件数 | カバー範囲 |
|------|------|------------|
| ユニットテスト | 5 | タイムスタンプ正規化 (3)、JSON パース (2) |
| 統合テスト | 2 | 正常系 E2E (1)、異常系 unknown field (1) |

### 不足しているテストケース

1. **境界値テスト**: 空文字 `traceId`/`deviceId`（バリデーション済みだがテストなし）
2. **タイムスタンプ異常系**: 不正な月（13月）、不正な日（2月30日）、閏年境界（2月29日の閏年/非閏年）
3. **JSON パーサー異常系**: 深いネスト（スタックオーバーフロー）、巨大文字列、不正な UTF-8
4. **ストアファイルの追記テスト**: 既存ファイルへの複数イベント追記と、各行の独立性検証
5. **環境変数フォールバック**: `FOOTPRINT_CORE_STORE_PATH`、`XDG_STATE_HOME`、`HOME` の優先順位テスト
6. **数値正規化テスト**: `1.00` → `1`、`-0.0` → `0`、指数表記 `1E+2` → `1e2` など
7. **kind 異常系**: 未知の kind 値（例: `"gps"`）の拒否テスト

---

## 5. CI インフラ (`ci.sh`)

### 良い点

- **3 フェーズ構成**（always_on → optional → guard）が明確
- **no-op green forbidden** ガードにより、テストが空で通過することを防止
- **fail_with_hint** パターンで、失敗時に修正方法を提示する UX が優秀
- 複数の Rust マニフェスト、backend、Android を将来的に追加可能な拡張性

### 改善提案

- `cargo fmt --check` と `cargo clippy` が CI に含まれていない。Rust のフォーマット/lint チェックを追加すべき（仕様 AGENTS.md §4 で「Format/lint/typecheck」が品質基準として明記されている）
- `cargo test` は `--release` ビルドでも実行すると、最適化による挙動差異を検出できる

---

## 6. ドキュメント

### 良い点

- **constitution ベースの SSOT 階層**が一貫している
- **RFC/DEC ログ**で設計判断の根拠が追跡可能
- **AGENTS.md** でマルチエージェント運用の役割と変更管理が定義されている
- **trace.schema.json** が JSON Schema 2020-12 準拠で、CI で構文検証されている

### 改善提案

- **README.md が存在しない**: 新規参加者やオープンソース公開を見据えると、プロジェクト概要・ビルド手順・実行例を記載した README があるとよい
- **trace.schema.json** と **実装のバリデーション**の間に微妙な乖離がある: スキーマでは `payload` は `"type": "object"` だが、実装では `null` も許容している（`lib.rs:290`）。スキーマ側に `"type": ["object", "null"]` を追加するか、ドキュメントで補足すべき
- **80_risks.md** にリスクが列挙されているが、対応状況のサマリービューがない

---

## 7. 総括と推奨アクション

### 即時（次のイテレーション）

1. `cargo fmt --check` と `cargo clippy` を `ci.sh` に追加する
2. テストケースの拡充（上記 §4 の不足リスト、特に境界値とタイムスタンプ異常系）
3. `trace.schema.json` の `payload` 型定義を実装と合わせる（`null` 許容の明示）

### 短期

4. `committed_at` の意味論を仕様で再確認・明確化する（キャプチャ時刻 vs コミット時刻）
5. JSON パーサーのファジングテスト（`cargo fuzz` の導入）
6. stdin 入力サイズの上限検討（CLI であっても防衛的に）

### 中長期

7. L0 → L1 インターフェース契約の策定
8. README.md の作成（ビルド手順、実行例、アーキテクチャ概要）
9. 複数イベント追記のパフォーマンス・整合性テスト

---

*Reviewed by: Claude (Opus 4.6)*
*CI status at review time: GREEN (5 unit + 2 integration tests passed)*
