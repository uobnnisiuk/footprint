# RFC-0003: 持続的近接仮説 — BG Encounter 保証線の再検討

## Status
Draft
Owner: (共同提案)
Date: 2026-02-06

## Context

DEC-0008 は Encounter 保証線を「FG=MUST / BG=BE」に固定した。BG Encounter を BE（上積み）とした理由は、iOS BG BLE の制約により「すれ違い数秒」での即時交換を保証線に置けないためである。

この判断は正しかったが、暗黙の前提として **「Encounter ≒ すれ違い数秒の BLE 交換」** という想定に引きずられていた。

一方、本アプリの着想は令和6年能登半島地震にある。突然の被災に備え、**平時から無操作で** LS が蓄積される設計を目指している。「活動開始ボタン」のような明示的操作を前提にすると、**災害がいつ起きるかわからない** という原点と矛盾する。

そこで本 RFC は、**「すれ違い数秒」ではなく「持続的近接（分〜時間〜日）」が救助価値の中心である** という仮説を提示し、BG Encounter の保証線を再検討する。

## 能登半島地震からの考察

令和6年能登半島地震で命に関わった状況を整理する。

| 状況 | 近接の性質 | 時間スケール |
|------|-----------|-------------|
| 倒壊家屋の下敷き | 同一建物・同一部屋 | 数時間〜数日 |
| 津波に巻き込まれた | 同一地区 | 数分〜数十分 |
| 孤立集落で救助待ち | 同一集落 | 数日 |
| 避難所への集合 | 同一建物 | 数時間〜数日 |

**共通点**: 救助に効く LS の中心は「すれ違い数秒」ではなく「持続的近接」。同じ建物、同じ地区、同じ集落に **分〜時間〜日の単位** で共存していた証拠が、救助判断の起点になる。

## 仮説（Sustained Proximity Hypothesis）

**iOS BG BLE は「すれ違い数秒」の検出を保証できないが、「持続的近接（数分以上）」の検出については確率的に十分な成功率が見込める。そして、災害救助で人命に直結する LS は、持続的近接から生成されるものが中心である。**

### 確率モデル

近接時間 T の間に n 回のスキャン機会があり、各回の検出成功確率が p とすると、少なくとも1回検出される確率 P は:

```
P = 1 − (1 − p)^n
```

#### 楽観パラメータ（スキャン 30 秒間隔、p=0.5）

| 近接時間 | n | P |
|----------|---|---|
| 3秒 | 0〜1 | ~50% 以下 |
| 1分 | ~2 | ~75% |
| 5分 | ~10 | ~99.9% |
| 30分 | ~60 | ほぼ確実 |

#### 悲観パラメータ（スキャン 2 分間隔、p=0.2）

| 近接時間 | n | P |
|----------|---|---|
| 3秒 | 0 | ~0% |
| 1分 | 0〜1 | ~20% |
| 5分 | ~2 | ~36% |
| 30分 | ~15 | **~96%** |
| 2時間 | ~60 | **ほぼ1** |

**重要**: 悲観パラメータ（p=0.2、2分間隔）でも、30分以上の持続的近接で96%以上の検出確率が見込める。仮定が多少悪化しても、持続近接なら勝ち得る。

### 仮説の境界

- **短時間すれ違い（〜数秒）**: BG 検出は不確実。BE（上積み）のまま
- **持続的近接（数分〜）**: BG 検出の累積確率が高い。**保証線の引き直しが検討可能**

## Goal

1. 「すれ違い数秒」と「持続的近接」を仕様上で区別する
2. 持続的近接に対する BG Encounter の検出確率を SPIKE で実測する
3. 実測結果に基づき、DEC-0008 の BG=BE を **短時間=BE / 持続近接=条件付き保証** に段階化する可能性を検討する

## Non-goals

- BG すれ違い数秒の保証線を引き上げること（これは引き続き BE）
- iOS OS 制約の回避・ハック
- FG=MUST の変更（FG は引き続き MUST）

## Proposal (Minimal Diff)

### Change A: 持続的近接の概念を導入

15_behavior_spec.md Section 5 および RISK-BLE-IOS-001 に、以下の区別を導入する。

| 近接タイプ | 定義 | BG 保証線（現行） | BG 保証線（提案） |
|-----------|------|-------------------|-------------------|
| **瞬間的すれ違い** | 数秒〜十数秒 | BE | BE（変更なし） |
| **持続的近接** | 同一空間に数分以上 | BE | **SPIKE 結果次第で引き上げ検討** |

### Change B: SPIKE-0003 の再設計

SPIKE-0003 の検証条件を「持続的近接の検出確率」にフォーカスして改訂する。

#### 測定すべき最小セット

| 指標 | 定義 |
|------|------|
| **T_detect** | 近接開始から「最初の検出」までの時間分布 |
| **P(N)** | N分の持続近接で「少なくとも1回検出」できる確率 |

#### 条件の軸

| 軸 | 値 |
|----|-----|
| iOS 端末状態 | ロック / 低電力モード / BG 滞在 |
| 近接形態 | 同室 / 同フロア / 隣室 / 上下階 |
| 距離 | 1m / 3m / 10m |
| 時間 | 1分 / 5分 / 30分 / 2時間 |

#### 成功判定（暫定）

- 持続的近接（5分以上、10m以内）での P(5) ≥ 80%
- 持続的近接（30分以上、10m以内）での P(30) ≥ 95%

### Change C: DEC-0008 の段階化（SPIKE 結果次第）

SPIKE-0003 の結果が成功判定を満たした場合、DEC-0008 を以下に更新する。

- **MUST**: Capture（ローカル永続）— 変更なし
- **MUST**: FG Encounter — 変更なし
- **BE**: BG 瞬間的すれ違い — 変更なし
- **HIGH_PROB** (新): BG 持続的近接 — 保証ではないが「十分高い確率で成立する」ことを仕様上認定

## Impact on SSOT
- Constitution: Change（Design Principles に持続的近接の考え方を追加）
- Core Fact Spec: No change
- Share Envelope Spec: No change
- Behavior Spec: Change（Section 5 に持続的近接の区別を導入）
- Risks: Change（RISK-BLE-IOS-001 の補足）
- Testplan: Change（SPIKE-0003 の改訂）

## Safety Check (Must)
- No guessing introduced: Yes（確率モデルは推定ではなく、実測で検証する前提）
- No claiming introduced: Yes（保証線の引き上げは SPIKE 結果に条件付き）
- Blank remains explicit: Yes

## Acceptance Criteria
- AC1: SPIKE-0003 が改訂された検証条件で実行され、T_detect と P(N) の実測データが得られる
- AC2: 実測データに基づき、持続的近接に対する BG 保証線の判断（引き上げ or BE 維持）が DEC として記録される
- AC3: 判断結果が DEC-0008、RISK-BLE-IOS-001、15_behavior_spec.md に反映される

## 設計根拠（なぜこの仮説が能登の文脈で筋が通るか）

災害は「活動開始ボタン」で始まらない。突然起きる。だから BG で動いていることが前提。

しかし、BG の制約下でも **救助に最も効く LS**（同一建物、同一地区、同一集落の証拠）は、**持続的近接** から生成される。そして持続的近接なら、iOS BG BLE の制約下でも累積検出確率は十分に高い可能性がある。

「すれ違い3秒を保証できないから凍結する」のではなく、「救助価値の中心（持続的近接）が BG で拾えるかを検証する」ことで、前に進む。
